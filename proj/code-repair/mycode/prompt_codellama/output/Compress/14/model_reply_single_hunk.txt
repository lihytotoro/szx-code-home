 The correct line at the INFILL location is:

    if (allNUL) {
        end--;
    }